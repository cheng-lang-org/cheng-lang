@importc("cheng_mm_live_count")
fn liveCount(): int64

@importc("cheng_mem_scope_push")
fn scopePush(): void*

@importc("cheng_mem_scope_pop")
fn scopePop()

@importc("cheng_malloc")
fn mmAlloc(size: int32): void*

@importc("cheng_mem_release")
fn mmRelease(p: void*)

fn main(): int32 =
    let start: int64 = liveCount()
    scopePush()
    for i in 0..<2000:
        let p: void* = mmAlloc(16)
        if p == nil:
            return 2
    scopePop()
    let mid: int64 = liveCount()
    if mid != start:
        return 1

    i = 0
    while i < 2000:
        let p2: void* = mmAlloc(16)
        if p2 == nil:
            return 2
        mmRelease(p2)
        i = i + 1
    let end: int64 = liveCount()
    if end != start:
        return 1
    return 0
