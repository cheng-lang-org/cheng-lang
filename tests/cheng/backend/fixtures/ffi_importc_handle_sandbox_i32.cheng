@importc("cheng_ffi_handle_new_i32")
fn handleNewI32(value: int32): uint64

@importc("cheng_ffi_handle_get_i32")
fn handleGetI32(handle: uint64, outValue: var int32): int32

@importc("cheng_ffi_handle_add_i32")
fn handleAddI32(handle: uint64, delta: int32, outValue: var int32): int32

@importc("cheng_ffi_handle_release_i32")
fn handleReleaseI32(handle: uint64): int32

fn main(): int32 =
    let h0: uint64 = handleNewI32(40)
    if h0 == uint64(0):
        return 1
    var out0: int32 = 0
    if handleGetI32(h0, out0) != 0 || out0 != 40:
        return 2
    if handleAddI32(h0, 2, out0) != 0 || out0 != 42:
        return 3
    if handleReleaseI32(h0) != 0:
        return 4
    var stale: int32 = 0
    if handleGetI32(h0, stale) != -1:
        return 5
    if handleAddI32(h0, 1, stale) != -1:
        return 6
    if handleReleaseI32(h0) != -1:
        return 7

    let h1: uint64 = handleNewI32(7)
    if h1 == uint64(0):
        return 8
    var out1: int32 = 0
    if handleGetI32(h1, out1) != 0 || out1 != 7:
        return 9
    if handleGetI32(h0, stale) != -1:
        return 10
    if handleReleaseI32(h1) != 0:
        return 11
    return 0
