import std/async_rt

var g_chan = chanI32New 4
var g_a: int32
var g_b: int32

@thread_boundary
fn producer() =
    chanI32Send(g_chan, g_a)
    chanI32Send(g_chan, g_b)

async fn asyncIdentity(x: int32): int32 =
    return x

async fn asyncAdd(a: int32, b: int32): int32 =
    let left: int32 = await asyncIdentity(a)
    return left + b

@thread_boundary
fn main(): int32 =
    g_a = 1
    g_b = 2
    spawn(producer)
    schedRun()
    var v0: int32 = 0
    var v1: int32 = 0
    if chanI32Recv(g_chan, v0) == 0:
        return 1
    if chanI32Recv(g_chan, v1) == 0:
        return 2
    let sum: int32 = await asyncAdd(v0, v1)
    if sum == 3:
        return 7
    return 3
