module backend_obj_fullspec

import std/system

var g_i32: int32 = 40
var g_i64: int64 = 2

type
    Pair =
        a: int32
        b: int32

fn id(x: T): T =
    return x

fn sum9(a: int32, b: int32, c: int32, d: int32, e: int32, f: int32, g: int32, h: int32, i: int32): int32 =
    return a + b + c + d + e + f + g + h + i

fn mkPair(a: int32, b: int32): Pair =
    return Pair(a: a, b: b)

fn testGlobals(): int32 =
    if g_i32 + int32(g_i64) != 42:
        return 1
    g_i32 = g_i32 + 1
    if g_i32 != 41:
        return 2
    return 0

fn testControlFlow(): int32 =
    var x: int32 = 0
    if 1 < 0:
        x = 10
    elif 2 < 1:
        x = 20
    else:
        x = 30
    if x != 30:
        return 1

    var sumFor: int32 = 0
    for i in 0..<5:
        sumFor = sumFor + i
    if sumFor != 10:
        return 2

    var i: int32 = 0
    var sumWhile: int32 = 0
    let __for_start_i_1 = i
    for __for_i_1 in __for_start_i_1..<10:
        i = __for_i_1
        if i == 5:
            break
        sumWhile = sumWhile + i
        i = i + 1
    if sumWhile != 10:
        return 3

    var j: int32 = 0
    var sumCont: int32 = 0
    let __for_start_j_2 = j
    for __for_j_2 in __for_start_j_2..<5:
        j = __for_j_2
        j = j + 1
        if j == 3:
            continue
        sumCont = sumCont + j
    if sumCont != 12:
        return 4

    let t: int32 = 1 + (1 < 2 ? 3 : 4)
    if t != 4:
        return 5

    if !((1 < 2 && 2 < 3) || (1 < 0)):
        return 6
    return 0

fn testBitwiseAndCast(): int32 =
    let v0: int32 = (1 | 2) ^ 3
    if v0 != 0:
        return 1
    let v1: int32 = (1 << 3) - (8 >> 1)
    if v1 != 4:
        return 2

    var u: uint32 = -1
    if int32(u >> 1) != 2147483647:
        return 3
    var s: int32 = -1
    if int32(s >> 1) != -1:
        return 4

    let w: int32 = 21
    if int64(w) != 21:
        return 5
    return 0

fn testPointers(): int32 =
    var x: int32 = 1
    let p: int64 = &x
    *p = 41
    if x != 41:
        return 1
    if *p != 41:
        return 2
    return 0

fn testObjectAndCalls(): int32 =
    var p0: Pair = mkPair(2, 3)
    if p0.a + p0.b != 5:
        return 1

    var p1: Pair
    p1.a = 1
    p1.b = 2
    var p2: Pair = p1
    p2.a = 3
    var p3: Pair
    p3 = p1
    p3.b = 5
    if p1.a + p1.b != 3:
        return 2

    if sum9(1, 2, 3, 4, 5, 6, 7, 8, 9) != 45:
        return 3
    if id[int32](7) != 7:
        return 4
    return 0

fn main(): int32 =
    if testGlobals() != 0:
        return 11
    if testControlFlow() != 0:
        return 12
    if testBitwiseAndCast() != 0:
        return 13
    if testPointers() != 0:
        return 14
    if testObjectAndCalls() != 0:
        return 15
    echo "fullspec ok"
    return 0
