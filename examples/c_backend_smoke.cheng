type Kind = enum
    kA
    kB

type Payload =
    case kind: Kind
        of kA:
            a: int
        of kB:
            b: int

type slice_int =
    ptr: void*
    len: int32

@importc("cheng_bounds_check")
fn boundsCheck(len: int32, idx: int32)
@importc("ptr_add")
fn ptrAdd(p: void*, offset: int32): void*
@importc("load_int32")
fn loadInt32(p: void*): int32

fn sumSlice(s: slice_int): int32 =
    var total: int32 = 0
    for i in 0..<s.len:
        boundsCheck(s.len, i)
        let offset: int32 = i * 4
        let p: void* = ptrAdd(s.ptr, offset)
        let v: int32 = loadInt32(p)
        total = total + v
    return total

fn main(): int32 =
    var p: Payload
    p.kind = kA
    p.a = 4
    let xs: slice_int = [1, 2, 3]
    let total: int32 = sumSlice xs
    if total == 6 && p.a == 4:
        return 7
    return 1
