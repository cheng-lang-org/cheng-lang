import cheng/web/runtime/memory
import cheng/web/std/server_http

type
    ServerAppHandler = fn (req: HttpRequest): HttpResponse

var
    serverHandler: ServerAppHandler

fn registerServerApp(handler: ServerAppHandler) =
    serverHandler = handler

@ exportc("server_handle")
fn server_handle(reqPtr: void*, reqLen: int32, outLenPtr: int32*): void* =
    let raw = readString(reqPtr, reqLen)
    let req = parseHttpRequest(raw)
    var res: HttpResponse
    if serverHandler != nil:
        res = serverHandler(req)
    else:
        res = notFoundResponse()
    let text = responseToHttp(res)
    if outLenPtr != nil:
        *outLenPtr = len(text)
    return void*(text)
