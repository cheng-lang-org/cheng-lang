import cheng/web/runtime/abi
import cheng/web/runtime/app
import cheng/web/runtime/view
import cheng/web/runtime/events
import cheng/web/runtime/bindings
import cheng/web/runtime/signals as sig
import std/strutils

type
    CounterState =
        view: View
        labelText: WebNode
        count: sig.Signal[int32]

var
    state: CounterState

fn countLabel(): str =
    return "Count: " + intToStr(sig.get(state.count))

fn updateCount(delta: int32) =
    let next = sig.get(state.count) + delta
    sig.set(state.count, next)

fn onInc(ev: WebEvent) =
    ev
    updateCount(1)

fn onDec(ev: WebEvent) =
    ev
    updateCount(-1)

fn onReset(ev: WebEvent) =
    ev
    sig.set(state.count, 0)

fn buildButton(v: View, label: str, handler: WebEventHandler): WebNode =
    let btn = createElement(v, "button")
    setAttr(v, btn, "class", "btn")
    let txt = createText(v, label)
    appendNode(v, btn, txt)
    onEvent(v, btn, "click", handler)
    return btn

fn appInit() =
    state.count = sig.signal[int32](0)

fn appMount(root: WebNode): int32 =
    state.view = newView(root)
    let container = createElement(state.view, "div")
    setAttr(state.view, container, "class", "counter")
    appendNode(state.view, 0, container)

    let labelBox = createElement(state.view, "div")
    setAttr(state.view, labelBox, "class", "label")
    state.labelText = createText(state.view, "")
    appendNode(state.view, labelBox, state.labelText)
    appendNode(state.view, container, labelBox)
    bindText(state.labelText, countLabel)

    let row = createElement(state.view, "div")
    setAttr(state.view, row, "class", "row")
    appendNode(state.view, container, row)
    appendNode(state.view, row, buildButton(state.view, "-", onDec))
    appendNode(state.view, row, buildButton(state.view, "+", onInc))
    appendNode(state.view, row, buildButton(state.view, "Reset", onReset))

    return 1

fn appUpdate(handle: int32) =
    handle

fn appUnmount(handle: int32) =
    handle
    if state.view != nil:
        clearBindings(state.view)

fn register() =
    registerApp(appInit, appMount, appUpdate, appUnmount)

register()
