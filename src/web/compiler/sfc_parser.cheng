import cheng/web/compiler/text_utils

type
    SfcFile =
        template: str
        script: str
        style: str
        styleScoped: bool

fn extractBlock(source: str, tag: str, scoped: bool*): str =
    if source == nil || tag == nil:
        return ""
    let openTag: str = "<" + tag
    let closeTag: str = "</" + tag + ">"
    let openIdx: int32 = indexOfSubstr(source, openTag, 0)
    if openIdx < 0:
        return ""
    let openEnd: int32 = indexOfSubstr(source, ">", openIdx)
    if openEnd < 0:
        return ""
    if scoped != nil && tag == "style":
        let raw = substr(source, openIdx, openEnd - openIdx)
        if indexOfSubstr(raw, "scoped", 0) >= 0:
            *scoped = true
    let contentStart: int32 = openEnd + 1
    let closeIdx: int32 = indexOfSubstr(source, closeTag, contentStart)
    if closeIdx < 0:
        return ""
    return substr(source, contentStart, closeIdx - contentStart)

fn parseSfc(source: str): SfcFile =
    var sfc: SfcFile
    sfc.styleScoped = false
    sfc.template = extractBlock(source, "template", nil)
    sfc.script = extractBlock(source, "script", nil)
    sfc.style = extractBlock(source, "style", &sfc.styleScoped)
    return sfc
