import cmdline
import std/os
import cheng/web/cli/build as web_build
import cheng/web/cli/dev_server
import cheng/web/cli/preview_server
import cheng/web/cli/route_manifest
import std/strings

@importc("cheng_native_server_main")
fn cheng_native_server_main(argc: int32, argv: str*): int32

fn printLine(text: str) =
    os.writeLine(os.get_stdout(), text)

fn printUsage() =
    printLine("usage: cheng web <command> [args]")
    printLine("")
    printLine("commands:")
    printLine("  dev             run dev server (polling reload)")
    printLine("  build           compile .cwc sources into .cheng/.css")
    printLine("  preview         run static preview server")
    printLine("  route-manifest  generate routes_manifest.cheng")
    printLine("")
    printLine("notes:")
    printLine("  - dev/preview accept --host/--port/--max-header/--max-body/--timeout-ms via native server.")

fn collectArgsFrom(startIndex: int32, count: int32): str[] =
    var out: str[] 
    for i in startIndex..count:
        out.add(cmdline.paramStr(i))
    return out

fn main(argc: int32, argv: str*): int32 =
    cmdline.__cheng_setCmdLine(argc, void*(argv))
    let count: int32 = cmdline.paramCount()
    if count <= 0:
        printUsage()
        return 1
    let cmd = cmdline.paramStr(1)
    if cmd == "--help" || cmd == "-h" || cmd == "help":
        printUsage()
        return 0
    if cmd == "dev":
        let args = collectArgsFrom(2, count)
        if ! dev_server.initDevServerArgs(args):
            return dev_server.devServerExitCode()
        return cheng_native_server_main(argc, argv)
    if cmd == "build":
        let args = collectArgsFrom(2, count)
        if ! web_build.buildProjectArgs(args):
            return web_build.buildExitCode()
        return 0
    if cmd == "preview":
        let args = collectArgsFrom(2, count)
        if ! preview_server.initPreviewServerArgs(args):
            return preview_server.previewServerExitCode()
        return cheng_native_server_main(argc, argv)
    if cmd == "route-manifest" || cmd == "manifest":
        let args = collectArgsFrom(2, count)
        return route_manifest.runRouteManifestArgs(args)
    printUsage()
    return 1
