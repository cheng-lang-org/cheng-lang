# std/async_rt (minimal, pure Cheng)

type
    ChengAwaitI32 =
        status: int32
        value: int32
type
    await_i32 = ref ChengAwaitI32

type
    ChengAwaitVoid =
        status: int32
type
    await_void = ref ChengAwaitVoid

type
    ChengChanI32 =
        cap: int32
        count: int32
        head: int32
        tail: int32
        buffer: int32*
type
    chan_i32 = ref ChengChanI32

@importc("cheng_spawn")
fn __cheng_spawn_raw(fn_ptr: void*, ctx: void*): void
type
    SpawnTask0 = ref
        entry: fn()

fn __spawn_trampoline0(raw: void*) =
    if raw == nil:
        return
    let task: SpawnTask0 = SpawnTask0(raw)
    if task == nil:
        return
    if task.entry != nil:
        task.entry()
    memRelease task

@thread_boundary
fn spawn(entry: fn()): void =
    if entry == nil:
        return
    let task: SpawnTask0 = new[SpawnTask0]()
    if task == nil:
        entry()
        return
    task.entry = entry
    memRetain task
    __cheng_spawn_raw(&__spawn_trampoline0, task)

@thread_boundary
fn spawn[T](entry: fn(T), ctx: T): void =
    if entry == nil:
        return
    entry(ctx)

@importc("cheng_sched_pending")
fn schedPending(): int32
@importc("cheng_sched_run_once")
fn schedRunOnce(): int32
@importc("cheng_sched_run")
fn schedRun(): void

@importc("cheng_async_pending_i32")
fn asyncPendingI32(): await_i32
@importc("cheng_async_ready_i32")
fn asyncReadyI32(value: int32): await_i32
@importc("cheng_async_set_i32")
fn asyncSetI32(state: await_i32, value: int32): void
@importc("cheng_await_i32")
fn awaitI32(state: await_i32): int32

@importc("cheng_async_pending_void")
fn asyncPendingVoid(): await_void
@importc("cheng_async_ready_void")
fn asyncReadyVoid(): await_void
@importc("cheng_async_set_void")
fn asyncSetVoid(state: await_void): void
@importc("cheng_await_void")
fn awaitVoid(state: await_void): void

@importc("cheng_chan_i32_new")
fn chanI32New(cap: int32): chan_i32
@importc("cheng_chan_i32_send")
@thread_boundary
fn chanI32Send(ch: chan_i32, value: int32): int32
@importc("cheng_chan_i32_recv")
@thread_boundary
fn chanI32Recv(ch: chan_i32, out: var int32): int32
