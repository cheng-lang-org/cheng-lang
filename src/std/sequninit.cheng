# sequninit.cheng - fixed-size sequence without implicit initialization semantics
#
# API 对齐 pkg://cheng/libp2p 的 utils/sequninit，便于机械替换 import。

import std/result

const
    maxSeqUninit = 256

type
    SeqUninit[T] =
        count: int32
        items: T[maxSeqUninit]

fn initSeqUninit(): SeqUninit[T] =
    var out: SeqUninit[T]
    out.count = 0
    return out

fn sequninitCount(seq: SeqUninit[T]): int32 =
    seq.count

fn sequninitCapacity(seq: SeqUninit[T]): int32 =
    seq
    return maxSeqUninit

fn sequninitIsEmpty(seq: SeqUninit[T]): bool =
    seq.count <= 0

fn sequninitGet(seq: SeqUninit[T], index: int32): Result[T] =
    if index < 0 || index >= seq.count:
        return Err[T]("sequninit: index out of range")
    return Ok[T](seq.items[index])

fn sequninitSet(seq: var SeqUninit[T], index: int32, value: T): Result[bool] =
    if index < 0 || index >= seq.count:
        return Err[bool]("sequninit: index out of range")
    seq.items[index] = value
    return Ok[bool](true)

fn sequninitAdd(seq: var SeqUninit[T], value: T): Result[bool] =
    if seq.count >= maxSeqUninit:
        return Err[bool]("sequninit: full")
    seq.items[seq.count] = value
    seq.count = seq.count + 1
    return Ok[bool](true)

fn sequninitPop(seq: var SeqUninit[T]): Result[T] =
    if seq.count <= 0:
        return Err[T]("sequninit: empty")
    let idx: int32 = seq.count - 1
    seq.count = idx
    return Ok[T](seq.items[idx])

fn sequninitClear(seq: var SeqUninit[T]) =
    seq.count = 0
