# varint.cheng - Varint encode/decode (unsigned, base-128)
#
# API 对齐 pkg://cheng/libp2p 的 utils/varint，便于机械替换 import。

import std/result
import std/rawbytes
import std/buffer

type
    VarintDecoded =
        value: int64
        next: int32

fn encodeUVarint(value: int64): Bytes =
    if value < 0:
        return emptyBytes()
    var v: int64 = value
    var buf: ByteBuffer = newByteBuffer()
    while true:
        let chunk: int32 = int32(v % 128)
        v = v / 128
        if v != 0:
            appendByte(buf, chunk + 128)
        else:
            appendByte(buf, chunk)
            break
    return toBytes(buf)

fn decodeUVarint(data: Bytes, offset: int32): Result[VarintDecoded] =
    if offset < 0:
        return Err[VarintDecoded]("varint: negative offset")
    var i: int32 = offset
    var mul: int64 = 1
    var result: int64 = 0
    let __for_start_i_1 = i
    for __for_i_1 in __for_start_i_1..<bytesLen(data):
        i = __for_i_1
        let b: int32 = bytesGet(data, i)
        let low: int32 = b % 128
        result = result + (int64(low) * mul)
        if b < 128:
            return Ok[VarintDecoded](VarintDecoded(value: result, next: i + 1))
        mul = mul * 128
        if mul <= 0:
            return Err[VarintDecoded]("varint: overflow")
        i = i + 1
    return Err[VarintDecoded]("varint: truncated input")

