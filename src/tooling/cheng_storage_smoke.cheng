# Fullchain storage smoke target.
# Keeps decentralized runtime/io_backend compile coverage while avoiding the
# very large CLI surface of cheng_storage.cheng that can destabilize stage1.

import cmdline
import std/os
import decentralized/runtime as druntime
import decentralized/io_backend as diob
import libp2p/utils/stringlist as stringlist

fn printLine(text: str) =
    os.writeLine(os.get_stdout(), text)

fn printUsage() =
    printLine("cheng_storage smoke")
    printLine("usage: cheng_storage [--help|-h|probe]")

fn runProbe(): int32 =
    let peers = stringlist.initStringList()
    let mode = druntime.parseStorageMode("local")
    let rt = druntime.initStorageWithP2P(
        mode,
        "build/cheng_storage",
        "build/cheng_storage/ledger.jsonl",
        "",
        peers
    )
    let backend = diob.IoBackend(runtime: rt)
    backend
    printLine("probe: ok")
    return 0

fn main(): int32 =
    if cmdline.paramCount() <= 0:
        printUsage()
        return 0
    let cmd = cmdline.paramStr(1)
    if cmd == "--help" || cmd == "-h" || cmd == "help":
        printUsage()
        return 0
    if cmd == "probe":
        return runProbe()
    printUsage()
    return 1
