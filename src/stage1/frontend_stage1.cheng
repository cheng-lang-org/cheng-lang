# Stage1 frontend (recovery mode): only supports self-host seed copy.
import std/strings
import std/cmdline
import stage1/frontend_lib


fn usageCli() =
    echo "Usage:"
    echo "  frontend_stage1 --mode:deps-list --file:<input.cheng> [--out:<output.deps.list>]"
    echo ""
    echo "Notes:"
    echo "  - C compile pipeline has been removed from this frontend entry."
    echo "  - Recovery mode only; supports deps-list."

fn runCli() =
    var mode: str = ""
    var inPath: str = ""
    var outPath: str = ""
    var modulesPath: str = ""
    for i in 1..paramCount():
        let a: str = paramStr i
        if (a == "--help"):
            usageCli()
            exit 0
        if (a == "-h"):
            usageCli()
            exit 0
        elif hasPrefix(a, "--mode:"):
            mode = dropPrefix(a, "--mode:")
        elif hasPrefix(a, "--file:"):
            inPath = dropPrefix(a, "--file:")
        elif hasPrefix(a, "--out:"):
            outPath = dropPrefix(a, "--out:")
        elif hasPrefix(a, "--modules:"):
            modulesPath = dropPrefix(a, "--modules:")
        else:
            let msg: str = "Unknown argument: " + a
            echo msg
            usageCli()
            exit 2

    if (mode == ""):
        mode = "deps-list"
    if (mode == "deps"):
        echo "Unsupported --mode: deps (removed; use deps-list)"
        usageCli()
        exit 2
    if (mode == "c") || (mode == "c-modules"):
        echo "Unsupported --mode: " + mode + " (C compile pipeline removed)"
        usageCli()
        exit 2
    if ! (mode == "deps-list"):
        let msg: str = "Unsupported --mode: " + mode
        echo msg
        usageCli()
        exit 2
    if (inPath == ""):
        echo "Missing --file:<input.cheng>"
        usageCli()
        exit 2
    let modeMsg: str = "cli: mode=" + mode
    stage1Trace modeMsg
    let fileMsg: str = "cli: file=" + inPath
    stage1Trace fileMsg
    if (mode == "deps-list"):
        if ! compileToDepsList(inPath, outPath):
            exit 1
        return

fn main(argc: int32, argv: str*): int32 =
    __cheng_setCmdLine(argc, void*(argv))
    if paramCount() > 0:
        runCli()
        return 0
    echo "frontend_stage1 start"
    echo "stage1 C compile pipeline removed; use --mode:deps-list"
    return 2
