import std/times
import std/strings

type
    FraudReport =
        reportId: str
        taskId: str
        requestId: str
        receiptId: str
        executorId: str
        reporterId: str
        reason: str
        evidenceCid: str
        severity: str
        epoch: int32
        ts: str

fn fraudReportTs(): str =
    return times.now().format("unix")

fn normalizeSeverity(text: str): str =
    if len(text) == 0:
        return "medium"
    if text == "low" || text == "medium" || text == "high":
        return text
    return text

fn buildFraudReportId(ev: FraudReport): str =
    let payload = ev.taskId + "|" + ev.requestId + "|" + ev.receiptId + "|" +
        ev.executorId + "|" + ev.reporterId + "|" + ev.reason + "|" +
        ev.severity + "|" + intToStr(ev.epoch) + "|" + ev.ts
    return "fraud-" + intToStr(int32(len(payload)))

fn normalizeFraudReport(ev: FraudReport): FraudReport =
    var out = ev
    out.severity = normalizeSeverity(out.severity)
    if len(out.ts) == 0:
        out.ts = fraudReportTs()
    if len(out.reportId) == 0:
        out.reportId = buildFraudReportId(out)
    return out
