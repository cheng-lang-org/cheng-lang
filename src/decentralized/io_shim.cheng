import cheng/decentralized/io_backend as iob
import cheng/decentralized/lease_token as dtoken
import cheng/libp2p/utils/bytes as bytes
import cheng/libp2p/utils/result as result

var
    lastIoError: str = ""

fn ioLastError(): str =
    if lastIoError == nil:
        return ""
    return lastIoError

fn clearIoError() =
    lastIoError = ""

fn readFileAuto(pathOrCid: str): str =
    let res: result.Result[str] = iob.readTextAuto(pathOrCid)
    if result.IsErr(res):
        lastIoError = result.Error(res)
        return ""
    lastIoError = ""
    return result.Value(res)

fn writeFileAuto(pathOrCid: str, content: str): str =
    let res: result.Result[str] = iob.writeTextAuto(pathOrCid, content)
    if result.IsErr(res):
        lastIoError = result.Error(res)
        return ""
    lastIoError = ""
    return result.Value(res)

fn writeFileAutoOk(pathOrCid: str, content: str): bool =
    let res: result.Result[str] = iob.writeTextAuto(pathOrCid, content)
    if result.IsErr(res):
        lastIoError = result.Error(res)
        return false
    lastIoError = ""
    return true

fn writeFileAutoWithLease(path: str, tokenPath: str): str =
    let tokenRes: result.Result[dtoken.LeaseToken] = dtoken.loadLeaseTokenFile(tokenPath)
    if result.IsErr(tokenRes):
        lastIoError = result.Error(tokenRes)
        return ""
    let res: result.Result[str] = iob.putFileWithLeaseAuto(path, result.Value(tokenRes))
    if result.IsErr(res):
        lastIoError = result.Error(res)
        return ""
    lastIoError = ""
    return result.Value(res)

fn writeFileAutoWithLeaseOk(path: str, tokenPath: str): bool =
    let tokenRes: result.Result[dtoken.LeaseToken] = dtoken.loadLeaseTokenFile(tokenPath)
    if result.IsErr(tokenRes):
        lastIoError = result.Error(tokenRes)
        return false
    let res: result.Result[str] = iob.putFileWithLeaseAuto(path, result.Value(tokenRes))
    if result.IsErr(res):
        lastIoError = result.Error(res)
        return false
    lastIoError = ""
    return true

fn writeTextAutoWithLease(content: str, tokenPath: str): str =
    let tokenRes: result.Result[dtoken.LeaseToken] = dtoken.loadLeaseTokenFile(tokenPath)
    if result.IsErr(tokenRes):
        lastIoError = result.Error(tokenRes)
        return ""
    let data = bytes.bytesFromString(content)
    let res: result.Result[str] = iob.storeBytesWithLeaseAuto(data, result.Value(tokenRes))
    if result.IsErr(res):
        lastIoError = result.Error(res)
        return ""
    lastIoError = ""
    return result.Value(res)

fn writeTextAutoWithLeaseOk(content: str, tokenPath: str): bool =
    let tokenRes: result.Result[dtoken.LeaseToken] = dtoken.loadLeaseTokenFile(tokenPath)
    if result.IsErr(tokenRes):
        lastIoError = result.Error(tokenRes)
        return false
    let data = bytes.bytesFromString(content)
    let res: result.Result[str] = iob.storeBytesWithLeaseAuto(data, result.Value(tokenRes))
    if result.IsErr(res):
        lastIoError = result.Error(res)
        return false
    lastIoError = ""
    return true
